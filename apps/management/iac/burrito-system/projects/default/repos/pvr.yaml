---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backend-pvr
  namespace: burrito-project-default
spec:
  secretStoreRef:
    kind: SecretStore
    name: infisical
  target:
    creationPolicy: Owner
  data:
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
        key: /projects/terraform/pvr/backend/APPLICATION_KEY_ID
    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
        key: /projects/terraform/pvr/backend/APPLICATION_KEY
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformRepository
metadata:
  name: pvr
  namespace: burrito-project-default
spec:
  repository:
    url: https://github.com/jdmcmahan/pvr-tf.git
    secretName: github-token
  terraform:
    enabled: true
  overrideRunnerSpec:
    env:
      - name: AWS_REQUEST_CHECKSUM_CALCULATION
        value: when_required
      - name: AWS_RESPONSE_CHECKSUM_VALIDATION
        value: when_required
      - name: TF_VAR_infisical_client_id
        valueFrom:
          secretKeyRef:
            name: infisical-credentials
            key: clientId
      - name: TF_VAR_infisical_client_secret
        valueFrom:
          secretKeyRef:
            name: infisical-credentials
            key: clientSecret
    envFrom:
      - secretRef:
          name: backend-pvr
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformLayer
metadata:
  name: pvr-prowlarr
  namespace: burrito-project-default
spec:
  branch: "main"
  repository:
    name: pvr
    namespace: burrito-project-default
  path: "apps/prowlarr"
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformLayer
metadata:
  name: pvr-sonarr
  namespace: burrito-project-default
spec:
  branch: "main"
  repository:
    name: pvr
    namespace: burrito-project-default
  path: "apps/sonarr"
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformLayer
metadata:
  name: pvr-radarr
  namespace: burrito-project-default
spec:
  branch: "main"
  repository:
    name: pvr
    namespace: burrito-project-default
  path: "apps/radarr"
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformLayer
metadata:
  name: pvr-readarr
  namespace: burrito-project-default
spec:
  branch: "main"
  repository:
    name: pvr
    namespace: burrito-project-default
  path: "apps/readarr"
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformLayer
metadata:
  name: pvr-lidarr
  namespace: burrito-project-default
spec:
  branch: "main"
  repository:
    name: pvr
    namespace: burrito-project-default
  path: "apps/lidarr"
