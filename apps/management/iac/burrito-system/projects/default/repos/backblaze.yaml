---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: backblaze
  namespace: burrito-project-default
spec:
  secretStoreRef:
    kind: SecretStore
    name: infisical
  target:
    creationPolicy: Owner
  data:
    - secretKey: applicationKeyId
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
        key: /projects/terraform/backblaze/APPLICATION_KEY_ID
    - secretKey: applicationKey
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        metadataPolicy: None
        key: /projects/terraform/backblaze/APPLICATION_KEY
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformRepository
metadata:
  name: backblaze
  namespace: burrito-project-default
spec:
  repository:
    url: https://github.com/jdmcmahan/backblaze-tf.git
    secretName: github-token
  terraform:
    enabled: true
  overrideRunnerSpec:
    env:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: backblaze
            key: applicationKeyId
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: backblaze
            key: applicationKey
      - name: AWS_REQUEST_CHECKSUM_CALCULATION
        value: when_required
      - name: AWS_RESPONSE_CHECKSUM_VALIDATION
        value: when_required
      - name: TF_VAR_b2_application_key_id
        valueFrom:
          secretKeyRef:
            name: backblaze
            key: applicationKeyId
      - name: TF_VAR_b2_application_key
        valueFrom:
          secretKeyRef:
            name: backblaze
            key: applicationKey
      - name: TF_VAR_infisical_client_id
        valueFrom:
          secretKeyRef:
            name: infisical-credentials
            key: clientId
      - name: TF_VAR_infisical_client_secret
        valueFrom:
          secretKeyRef:
            name: infisical-credentials
            key: clientSecret
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformLayer
metadata:
  name: backblaze-omni
  namespace: burrito-project-default
spec:
  branch: "main"
  repository:
    name: backblaze
    namespace: burrito-project-default
  path: "omni"
---
apiVersion: config.terraform.padok.cloud/v1alpha1
kind: TerraformLayer
metadata:
  name: backblaze-pvr
  namespace: burrito-project-default
spec:
  branch: "main"
  repository:
    name: backblaze
    namespace: burrito-project-default
  path: "pvr"
